<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A blog about programming."><title>Iterating through a COM collection using the IObjectArray interface | Vadim Macagon</title><link rel="stylesheet" type="text/css" href="../../../../../css/normalize.min.css"><link rel="stylesheet" type="text/css" href="../../../../../css/pure-min.css"><link rel="stylesheet" type="text/css" href="../../../../../css/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="../../../../../css/style.css"><link rel="stylesheet" type="text/css" href="../../../../../css/codemirror.css"><link rel="Shortcut Icon" type="image/x-icon" href="../../../../../favicon.ico"><link rel="apple-touch-icon" href="../../../../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../../../../apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Iterating through a COM collection using the IObjectArray interface</h1><a id="logo" href="../../../../../.">Vadim Macagon</a><p class="description">/(software (developer|engineer))|programmer/</p></div><div id="nav-menu"><a href="../../../../../." class="current">Blog</a><a href="../../../../../projects/">projects</a><a href="../../../../../about/">About</a><a href="../../../../../archives/">Archive</a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Iterating through a COM collection using the IObjectArray interface</h1><div class="post-meta">Aug 15, 2016</div><!--if theme.disqus--><!--  a.disqus-comment-count(data-disqus-identifier=page.path, href=url_for(page.path) + '#disqus_thread')--><div class="post-content"><p>Every so often I need to write some code that uses <abbr title="Component Object Model">COM</abbr> interfaces, but since I do so rather
infrequently I often forget the <abbr title="Component Object Model">COM</abbr> reference counting rules. The <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms692481(v=vs.85).aspx" target="_blank" rel="external">rules are documented on
MSDN</a> but the documentation could really do with some basic examples, and finding
such examples elsewhere can be rather difficult in my experience (perhaps they’re all in paper
books). So this post is going to present one such example, primarily to help my future
forgetful self.</p>
<p>Here’s a function that iterates through the objects an <code>IObjectArray</code> and invokes a callback
function for each object:</p>
<figure class="highlight">
       <table>
         <tbody>
           <tr>
             <td class="gutter">
               <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre>
             </td>
             <td class="code">
               <pre class="cm-s-default"><div class="line"><span class="cm-keyword">template</span> <span class="cm-operator">&lt;</span><span class="cm-keyword">typename</span> <span class="cm-variable">T</span><span class="cm-operator">&gt;</span></div><div class="line"><span class="cm-variable-3">void</span> <span class="cm-def">ForEachObject</span>(<span class="cm-variable">IObjectArray</span><span class="cm-operator">*</span> <span class="cm-variable">objectArrayPtr</span>,</div><div class="line">                   <span class="cm-variable">std::function</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">void</span>(<span class="cm-variable">T</span><span class="cm-operator">*</span>)<span class="cm-operator">&gt;</span> <span class="cm-variable">callback</span>)</div><div class="line">{</div><div class="line">  <span class="cm-variable">UINT</span> <span class="cm-variable">count</span>;</div><div class="line">  <span class="cm-keyword">if</span> (<span class="cm-variable">FAILED</span>(<span class="cm-variable">objectArray</span><span class="cm-operator">-&gt;</span><span class="cm-variable">GetCount</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">count</span>)))</div><div class="line">    <span class="cm-keyword">return</span>;</div><div class="line"></div><div class="line">  <span class="cm-variable">T</span><span class="cm-operator">*</span> <span class="cm-variable">objectPtr</span>;</div><div class="line">  <span class="cm-keyword">for</span> (<span class="cm-variable">UINT</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">count</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</div><div class="line">  {</div><div class="line">    <span class="cm-comment">// IObjectArray::GetAt() will call AddRef() on the returned object.</span></div><div class="line">    <span class="cm-keyword">if</span> (<span class="cm-variable">SUCCEEDED</span>(<span class="cm-variable">objectArrayPtr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">GetAt</span>(<span class="cm-variable">i</span>, <span class="cm-variable">IID_PPV_ARGS</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">objectPtr</span>))))</div><div class="line">    {</div><div class="line">      <span class="cm-variable">callback</span>(<span class="cm-variable">objectPtr</span>);</div><div class="line">      <span class="cm-comment">// Call Release() when we&#39;re done with the object to decrement the</span></div><div class="line">      <span class="cm-comment">// reference count that was incremented by IObjectArray::GetAt().</span></div><div class="line">      <span class="cm-variable">objectPtr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Release</span>();</div><div class="line">    }</div><div class="line">    <span class="cm-comment">// NOTE: If IObjectArray::GetAt() fails above we just keep on going,</span></div><div class="line">    <span class="cm-comment">//       but the error handling strategy can of course differ on a</span></div><div class="line">    <span class="cm-comment">//       case by case basis.</span></div><div class="line">  }</div><div class="line">}</div></pre>
             </td>
           </tr>
         </tbody>
       </table>
     </figure>
<p>The same function could be written using <code>CComPtr</code>, though there really isn’t much point in doing
so in this particular case:</p>
<figure class="highlight">
       <table>
         <tbody>
           <tr>
             <td class="gutter">
               <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre>
             </td>
             <td class="code">
               <pre class="cm-s-default"><div class="line"><span class="cm-keyword">template</span> <span class="cm-operator">&lt;</span><span class="cm-keyword">typename</span> <span class="cm-variable">T</span><span class="cm-operator">&gt;</span></div><div class="line"><span class="cm-variable-3">void</span> <span class="cm-def">ForEachObject</span>(<span class="cm-variable">IObjectArray</span><span class="cm-operator">*</span> <span class="cm-variable">objectArrayPtr</span>,</div><div class="line">                   <span class="cm-variable">std::function</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">void</span>(<span class="cm-variable">T</span><span class="cm-operator">*</span>)<span class="cm-operator">&gt;</span> <span class="cm-variable">callback</span>)</div><div class="line">{</div><div class="line">  <span class="cm-variable">UINT</span> <span class="cm-variable">count</span>;</div><div class="line">  <span class="cm-keyword">if</span> (<span class="cm-variable">FAILED</span>(<span class="cm-variable">objectArray</span><span class="cm-operator">-&gt;</span><span class="cm-variable">GetCount</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">count</span>)))</div><div class="line">    <span class="cm-keyword">return</span>;</div><div class="line"></div><div class="line">  <span class="cm-keyword">for</span> (<span class="cm-variable">UINT</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">count</span>; <span class="cm-operator">++</span><span class="cm-variable">i</span>)</div><div class="line">  {</div><div class="line">    <span class="cm-comment">// This CComPtr will be destroyed at the end of each iteration, and the</span></div><div class="line">    <span class="cm-comment">// destructor will decrement the reference count that was incremented by</span></div><div class="line">    <span class="cm-comment">// IObjectArray::GetAt().</span></div><div class="line">    <span class="cm-variable">CComPtr</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">objectPtr</span>;</div><div class="line">    <span class="cm-comment">// IObjectArray::GetAt() will call AddRef() on the returned object.</span></div><div class="line">    <span class="cm-keyword">if</span> (<span class="cm-variable">SUCCEEDED</span>(<span class="cm-variable">objectArrayPtr</span><span class="cm-operator">-&gt;</span><span class="cm-variable">GetAt</span>(<span class="cm-variable">i</span>, <span class="cm-variable">IID_PPV_ARGS</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">objectPtr</span>))))</div><div class="line">    {</div><div class="line">      <span class="cm-variable">callback</span>(<span class="cm-variable">objectPtr</span>);</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div></pre>
             </td>
           </tr>
         </tbody>
       </table>
     </figure>
<p>And here’s an example of using the function implemented above:</p>
<figure class="highlight">
       <table>
         <tbody>
           <tr>
             <td class="gutter">
               <pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre>
             </td>
             <td class="code">
               <pre class="cm-s-default"><div class="line"><span class="cm-variable-3">int</span> <span class="cm-variable">counter</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</div><div class="line"><span class="cm-variable">ForEachObject</span><span class="cm-operator">&lt;</span><span class="cm-variable">IShellItem</span><span class="cm-operator">&gt;</span>(</div><div class="line">  <span class="cm-variable">objectArray</span>,</div><div class="line">  [<span class="cm-operator">&amp;</span><span class="cm-variable">counter</span>](<span class="cm-variable">IShellItem</span><span class="cm-operator">*</span> <span class="cm-variable">item</span>) { <span class="cm-operator">++</span><span class="cm-variable">counter</span>; }</div><div class="line">);</div></pre>
             </td>
           </tr>
         </tbody>
       </table>
     </figure>
</div><div class="tags"><a href="../../../../../tags/c/"><svg name="tag" class="fa" viewBox="0 0 1536 1792" width="16px" height="16px" aria-hidden="true"><g transform="scale(1,-1) translate(0,-1536)"><path d="M448 1088q0 53 -37.5 90.5t-90.5 37.5t-90.5 -37.5t-37.5 -90.5t37.5 -90.5t90.5 -37.5t90.5 37.5t37.5 90.5zM1515 512q0 -53 -37 -90l-491 -492q-39 -37 -91 -37q-53 0 -90 37l-715 716q-38 37 -64.5 101t-26.5 117v416q0 52 38 90t90 38h416q53 0 117 -26.5t102 -64.5 l715 -714q37 -39 37 -91z"/></g></svg>c++</a><a href="../../../../../tags/COM/"><svg name="tag" class="fa" viewBox="0 0 1536 1792" width="16px" height="16px" aria-hidden="true"><g transform="scale(1,-1) translate(0,-1536)"><path d="M448 1088q0 53 -37.5 90.5t-90.5 37.5t-90.5 -37.5t-37.5 -90.5t37.5 -90.5t90.5 -37.5t90.5 37.5t37.5 90.5zM1515 512q0 -53 -37 -90l-491 -492q-39 -37 -91 -37q-53 0 -90 37l-715 716q-38 37 -64.5 101t-26.5 117v416q0 52 38 90t90 38h416q53 0 117 -26.5t102 -64.5 l715 -714q37 -39 37 -91z"/></g></svg>COM</a></div><div class="post-nav"><a href="../../../../2014/10/29/build-a-ue4-compatible-static-lib-in-vs2013/" class="next">Build a UE4 compatible static lib in VS2013<svg name="caret-right" class="fa" viewBox="0 0 640 1792" width="16px" height="16px" aria-hidden="true"><g transform="scale(1,-1) translate(0,-1536)"><path d="M576 640q0 -26 -19 -45l-448 -448q-19 -19 -45 -19t-45 19t-19 45v896q0 26 19 45t45 19t45 -19l448 -448q19 -19 19 -45z"/></g></svg></a></div><div id="disqus_thread"><script>var disqus_shortname = 'vadimmacagon';
var disqus_identifier = 'blog/2016/08/15/iterating-com-collection-using-iobjectarray/';
var disqus_title = 'Iterating through a COM collection using the IObjectArray interface';
var disqus_url = 'http://vadim.macagon.com/blog/2016/08/15/iterating-com-collection-using-iobjectarray/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//vadimmacagon.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://vadim.macagon.com"/></form></div><div class="widget"><div class="widget-title">tags</div><div class="tagcloud"><a href="../../../../../tags/ue4/" style="font-size: 1em;">ue4</a> <a href="../../../../../tags/c/" style="font-size: 1em;">c++</a> <a href="../../../../../tags/COM/" style="font-size: 1em;">COM</a></div></div><div class="widget"><div class="widget-title">recent posts</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="">Iterating through a COM collection using the IObjectArray interface</a></li><li class="post-list-item"><a class="post-list-link" href="../../../../2014/10/29/build-a-ue4-compatible-static-lib-in-vs2013/">Build a UE4 compatible static lib in VS2013</a></li></ul></div><div class="widget"><div class="widget-title">social</div><ul><li class="color-on-hover"><a href="https://twitter.com/macagonator" rel="noopener noreferrer" title="My Twitter Profile" target="_blank"><svg name="twitter" class="fa" viewBox="0 0 1664 1792" width="16px" height="16px" aria-hidden="true"><g transform="scale(1,-1) translate(0,-1536)"><path d="M1620 1128q-67 -98 -162 -167q1 -14 1 -42q0 -130 -38 -259.5t-115.5 -248.5t-184.5 -210.5t-258 -146t-323 -54.5q-271 0 -496 145q35 -4 78 -4q225 0 401 138q-105 2 -188 64.5t-114 159.5q33 -5 61 -5q43 0 85 11q-112 23 -185.5 111.5t-73.5 205.5v4q68 -38 146 -41 q-66 44 -105 115t-39 154q0 88 44 163q121 -149 294.5 -238.5t371.5 -99.5q-8 38 -8 74q0 134 94.5 228.5t228.5 94.5q140 0 236 -102q109 21 205 78q-37 -115 -142 -178q93 10 186 50z"/></g></svg>macagonator</a></li><li class="color-on-hover"><a href="https://github.com/enlight" rel="noopener noreferrer" title="My GitHub Profile" target="_blank"><svg name="github" class="fa" viewBox="0 0 1536 1792" width="16px" height="16px" aria-hidden="true"><g transform="scale(1,-1) translate(0,-1536)"><path d="M768 1408q209 0 385.5 -103t279.5 -279.5t103 -385.5q0 -251 -146.5 -451.5t-378.5 -277.5q-27 -5 -40 7t-13 30q0 3 0.5 76.5t0.5 134.5q0 97 -52 142q57 6 102.5 18t94 39t81 66.5t53 105t20.5 150.5q0 119 -79 206q37 91 -8 204q-28 9 -81 -11t-92 -44l-38 -24 q-93 26 -192 26t-192 -26q-16 11 -42.5 27t-83.5 38.5t-85 13.5q-45 -113 -8 -204q-79 -87 -79 -206q0 -85 20.5 -150t52.5 -105t80.5 -67t94 -39t102.5 -18q-39 -36 -49 -103q-21 -10 -45 -15t-57 -5t-65.5 21.5t-55.5 62.5q-19 32 -48.5 52t-49.5 24l-20 3q-21 0 -29 -4.5 t-5 -11.5t9 -14t13 -12l7 -5q22 -10 43.5 -38t31.5 -51l10 -23q13 -38 44 -61.5t67 -30t69.5 -7t55.5 3.5l23 4q0 -38 0.5 -88.5t0.5 -54.5q0 -18 -13 -30t-40 -7q-232 77 -378.5 277.5t-146.5 451.5q0 209 103 385.5t279.5 279.5t385.5 103zM291 305q3 7 -7 12 q-10 3 -13 -2q-3 -7 7 -12q9 -6 13 2zM322 271q7 5 -2 16q-10 9 -16 3q-7 -5 2 -16q10 -10 16 -3zM352 226q9 7 0 19q-8 13 -17 6q-9 -5 0 -18t17 -7zM394 184q8 8 -4 19q-12 12 -20 3q-9 -8 4 -19q12 -12 20 -3zM451 159q3 11 -13 16q-15 4 -19 -7t13 -15q15 -6 19 6z M514 154q0 13 -17 11q-16 0 -16 -11q0 -13 17 -11q16 0 16 11zM572 164q-2 11 -18 9q-16 -3 -14 -15t18 -8t14 14z"/></g></svg>enlight</a></li><li class="color-on-hover"><a href="https://bitbucket.org/enlight" rel="noopener noreferrer" title="My BitBucket Profile" target="_blank"><svg name="bitbucket" class="fa" viewBox="0 0 1408 1792" width="16px" height="16px" aria-hidden="true"><g transform="scale(1,-1) translate(0,-1536)"><path d="M815 677q8 -63 -50.5 -101t-111.5 -6q-39 17 -53.5 58t-0.5 82t52 58q36 18 72.5 12t64 -35.5t27.5 -67.5zM926 698q-14 107 -113 164t-197 13q-63 -28 -100.5 -88.5t-34.5 -129.5q4 -91 77.5 -155t165.5 -56q91 8 152 84t50 168zM1165 1240q-20 27 -56 44.5t-58 22 t-71 12.5q-291 47 -566 -2q-43 -7 -66 -12t-55 -22t-50 -43q30 -28 76 -45.5t73.5 -22t87.5 -11.5q228 -29 448 -1q63 8 89.5 12t72.5 21.5t75 46.5zM1222 205q-8 -26 -15.5 -76.5t-14 -84t-28.5 -70t-58 -56.5q-86 -48 -189.5 -71.5t-202 -22t-201.5 18.5q-46 8 -81.5 18 t-76.5 27t-73 43.5t-52 61.5q-25 96 -57 292l6 16l18 9q223 -148 506.5 -148t507.5 148q21 -6 24 -23t-5 -45t-8 -37zM1403 1166q-26 -167 -111 -655q-5 -30 -27 -56t-43.5 -40t-54.5 -31q-252 -126 -610 -88q-248 27 -394 139q-15 12 -25.5 26.5t-17 35t-9 34t-6 39.5 t-5.5 35q-9 50 -26.5 150t-28 161.5t-23.5 147.5t-22 158q3 26 17.5 48.5t31.5 37.5t45 30t46 22.5t48 18.5q125 46 313 64q379 37 676 -50q155 -46 215 -122q16 -20 16.5 -51t-5.5 -54z"/></g></svg>enlight</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© 2014-2016 <a href="../../../../../." rel="nofollow">Vadim Macagon.</a> Powered by<a rel="nofollow noopener noreferrer" target="_blank" href="https://hexo.io"> Hexo.</a> Theme based on<a rel="nofollow noopener noreferrer" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> a theme by Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a></div></body></html>